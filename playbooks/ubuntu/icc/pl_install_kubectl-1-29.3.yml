- hosts: all
  tasks:
    - name: Get latest kubectl version
      uri:
        url: https://dl.k8s.io/release/stable.txt
        return_content: yes
      register: version

    - name: Download the latest kubectl release
      uri:
        url: "https://dl.k8s.io/release/v1.29.3/bin/linux/amd64/kubectl"
        dest: "~/kubectl"
      register: kubectl

    - name: Download the kubectl checksum file
      uri:
        url: "https://dl.k8s.io/release/v1.29.3/bin/linux/amd64/kubectl.sha256"
        dest: "~/kubectl.sha256"

    - name: Validate the kubectl binary against the checksum file
      shell: "echo \"$(cat ~/kubectl.sha256)  ~/kubectl\" | sha256sum --check"
      args:
        chdir: "~/"
      register: result
      failed_when: "'OK' not in result.stdout"

    - name: Move kubectl and change permissions
      become: yes
      copy:
        src: "~/kubectl"
        dest: /usr/local/bin/kubectl
        remote_src: yes
        owner: root
        group: root
        mode: '0755'

    - name: Check if kubectl is installed
      command: kubectl version --client
      register: client
      failed_when: client.rc > 1
